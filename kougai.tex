\documentclass{maelab_y}
%\documentstyle{jarticle}
\usepackage{graphicx}
\usepackage[dvipdfmx]{color}
\usepackage{multirow}
\usepackage{here}
\usepackage{amsmath}
\usepackage{array}

\newcommand{\figtb}[5]{ %引数 {日本語タイトル}{英語タイトル}{サイズ}{ファイル名}{ラベル名}{{{
%\vspace{-0.5em}
\begin{figure}[hbtp]
  \begin{center}
    \includegraphics[width=#3cm,clip]{figure/#4}
    \caption{#1}
    \label{fig:#5}
  \end{center}
\end{figure}
%\vspace{-1em}
}%}}}

\newcommand{\分類条件}{%{{{
\begin{table}[t]
\begin{center}
\caption{進行方向を分類する条件}
\ecaption{Classification condition of moving direction $e_{i}$.}
\label{tb:hantei_jouken}
\begin{tabular}{c|c|c|c|c}
\hline \hline
			& 右 & 左 & 上 & 下 \\ \hline
パターン2   & $\frac{1}{\sqrt{2}} < e_x \leq 1  $
		    & $ -1 \leq e_x < \frac{-1}{\sqrt{2}}$ 
		    & $ \frac{-1}{\sqrt{2}} < e_x < \frac{1}{\sqrt{2}} $ 
		    & $ \frac{-1}{2} < e_x < \frac{1}{2} $ \\
パターン3   & $\frac{-1}{2} < e_y < \frac{1}{2} $ 
		    & $\frac{-1}{2} < e_y < \frac{1}{2} $
            & $ \frac{1}{\sqrt{2}} < e_y \leq 1$
		    & $ -1 \leq e_y < \frac{-1}{\sqrt{2}} $ \\
\hline
\multirow{2}{*}{パターン4}   
			& $R_x \geq A_x$ & $R_x < A_x$ & $R_y \geq A_y$ & $R_y < A_y $ \\
	        &  $L_x \geq A_x$ & $L_x < A_x$ & $L_y \geq A_y$ & $L_y < A_y$ \\
\hline
\multirow{2}{*}{パターン5}   
 			& $R_x \geq x_1$ & $R_x < x_2$ & $R_y \geq y_1$ & $R_y < y_2 $ \\
			& $L_x \geq x_1$ & $L_x < x_2$ & $L_y \geq y_1$ & $L_y < y_2 $ \\
\hline
パターン6   & $ \cos(\frac{1}{2}\theta_{view}) \leq  e_y $ 
			& $ e_y \leq -\cos(\frac{1}{2}\theta_{view})$ 
			& $ \sin(\frac{1}{2}(\pi - \theta_{view})) \leq e_x $ 
			& $ e_x \leq \sin(\frac{1}{2}(\pi - \theta_{view}))  $ \\
\hline
\end{tabular}
\end{center}
\end{table}
}%}}}

\newcommand{\距離計算new}{%{{{
  \begin{table}[hbtp]
    \begin{center}
    \caption{エージェント間距離の計算回数[$10^{10}$回]}
    \label{tb:keisan_kaisu}
    \begin{tabular}{c|llllll}
    \hline \hline
    \multirow{2}{*}{人数}   & \multicolumn{6}{c}{パターン}                                                                                                                                                             \\ \cline{2-7} 
                          & \multicolumn{1}{c|}{1}    & \multicolumn{1}{c|}{2}               & \multicolumn{1}{c|}{3}      & \multicolumn{1}{c|}{4}      & \multicolumn{1}{c|}{5}      & \multicolumn{1}{c}{6}    \\ \hline
    \multirow{2}{*}{3000} & \multicolumn{1}{r|}{5.1}  & \multicolumn{1}{r|}{\textbf{3.9}}    & \multicolumn{1}{r|}{4.0}    & \multicolumn{1}{r|}{4.4}    & \multicolumn{1}{r|}{4.1}    & \multicolumn{1}{r}{4.4}  \\
                          & \multicolumn{1}{l|}{}     & \multicolumn{1}{l|}{\textbf{(24\%)}} & \multicolumn{1}{l|}{(23\%)} & \multicolumn{1}{l|}{(15\%)} & \multicolumn{1}{l|}{(21\%)} & (15\%)                   \\ \hline
    \multirow{2}{*}{5000} & \multicolumn{1}{r|}{14.4} & \multicolumn{1}{r|}{\textbf{10.9}}   & \multicolumn{1}{r|}{11.1}   & \multicolumn{1}{r|}{12.2}   & \multicolumn{1}{r|}{11.4}   & \multicolumn{1}{r}{12.2} \\
                          & \multicolumn{1}{l|}{}     & \multicolumn{1}{l|}{\textbf{(24\%)}} & \multicolumn{1}{l|}{(23\%)} & \multicolumn{1}{l|}{(15\%)} & \multicolumn{1}{l|}{(21\%)} & (15\%)                   \\ \hline
    \multirow{2}{*}{7500} & \multicolumn{1}{r|}{33.1} & \multicolumn{1}{r|}{\textbf{25.2}}   & \multicolumn{1}{r|}{25.8}   & \multicolumn{1}{r|}{28.3}   & \multicolumn{1}{r|}{26.7}   & \multicolumn{1}{r}{28.3} \\
                          & \multicolumn{1}{l|}{}     & \multicolumn{1}{l|}{\textbf{(24\%)}} & \multicolumn{1}{l|}{(22\%)} & \multicolumn{1}{l|}{(15\%)} & \multicolumn{1}{l|}{(20\%)} & (15\%)                   \\ \hline
    \end{tabular}
    \end{center}
    \end{table}
}%}}}

\newcommand{\粒子数}{%{{{
\begin{table}[hbtp]
  \begin{center}
    \caption{各配置の詳細}
    \label{tb:haichi_para}
    \begin{tabular}{c|c|c}
      \hline \hline
      & 教室 & 演習室 \\ \hline 
      エージェント数[人] & 96 & 204 \\ \hline
      壁粒子数[個] & 1037 & 1454\\ \hline
      経由地数[個] & 12   & 26 \\ \hline
      解析領域 & $50m\times50m$ & $50m\times50m$ \\ \hline
    \end{tabular}
  \end{center}
\end{table}
}%}}}

\newcommand{\評価環境}{%{{{
\begin{table}[hbtp]
  \begin{center}
    \caption{各配置の詳細}
    \label{tb:haichi_para}
    \begin{tabular}{c|c|c}
      \hline \hline
                 & マシン1                & マシン2 \\ \hline 
      CPU        & Intel Xeon E5-2687W & Intel Xeon E5-2667W \\ \hline
      メモリ     & 64GB                   & 64GB \\ \hline
      OS         & Linux 4.12.9            & Linux 6.5.8 \\ \hline
      コンパイラ & gcc 7.2.0             & gcc 13.2.0 \\ \hline
    \end{tabular}
  \end{center}
\end{table}
}%}}}

\newcommand{\判定条件new}{%{{{
  \begin{table}[hbtp]
    \centering
		\caption{パターンごとの進行方向分類条件}
		\label{tb:joken}
		{\scriptsize
    \begin{tabular}{Wc{0.5em}|cccWc{8em}}
    \hline \hline
    %\multirow{2}{*}{} & \multicolumn{4}{c}{パターン}                                                        \\ \cline{2-5} 
                          & \multicolumn{1}{c|}{パターン2，3} & \multicolumn{1}{c|}{パターン4}   & \multicolumn{1}{c|}{パターン5}   & パターン6                   \\ \hline
    \multirow{2}{*}{右}    & \multicolumn{1}{c|}{$\frac{1}{\sqrt{2}} < e_x \leq 1$}  & \multicolumn{1}{c|}{$R_x \geq A_x$}  & \multicolumn{1}{c|}{$R_x \geq x_1$}  & \multirow{2}{*}{$ \cos(\frac{1}{2}\theta_v) \leq  e_y $} \\
                          & \multicolumn{1}{c|}{$\frac{-1}{2} < e_y < \frac{1}{2} $}   & \multicolumn{1}{l|}{$L_x \geq A_x$} & \multicolumn{1}{l|}{$L_x \geq x_1$} &                     \\ \hline
    \multirow{2}{*}{左}    & \multicolumn{1}{c|}{$ -1 \leq e_x < \frac{-1}{\sqrt{2}}$}  & \multicolumn{1}{c|}{$R_x < A_x$}  & \multicolumn{1}{c|}{$R_x < x_2$}  & \multirow{2}{*}{$ e_y \leq -\cos(\frac{1}{2}\theta_{v})$} \\
                          & \multicolumn{1}{l|}{$\frac{-1}{2} < e_y < \frac{1}{2} $}   & \multicolumn{1}{l|}{$L_x < A_x$} & \multicolumn{1}{l|}{$L_x < x_2$ } &                     \\ \hline
    \multirow{2}{*}{上}    & \multicolumn{1}{c|}{$ \frac{-1}{\sqrt{2}} < e_x < \frac{1}{\sqrt{2}}$}  & \multicolumn{1}{c|}{$R_y \geq A_y$ }  & \multicolumn{1}{c|}{$R_y \geq y_1$ }  & \multirow{2}{*}{$ \sin(\frac{1}{2}(\theta_{\pi - v})) \leq e_x$} \\
                          & \multicolumn{1}{l|}{$ \frac{1}{\sqrt{2}} < e_y \leq 1$}   & \multicolumn{1}{l|}{$L_y \geq A_y$} & \multicolumn{1}{l|}{$L_y \geq y_1$} &                     \\ \hline
    \multirow{2}{*}{下}    & \multicolumn{1}{c|}{$ \frac{-1}{2} < e_x < \frac{1}{2} $}  & \multicolumn{1}{c|}{$R_y < A_y $}  & \multicolumn{1}{c|}{$R_y < y_2 $ }  & \multirow{2}{*}{$ e_x \leq \sin(\frac{1}{2}(\theta_{\pi - v}))$} \\
                          & \multicolumn{1}{l|}{$ -1 \leq e_y < \frac{-1}{\sqrt{2}} $}   & \multicolumn{1}{l|}{$L_y < A_y$} & \multicolumn{1}{l|}{$L_y < y_2 $ } &                     \\ \hline
    \end{tabular}
		}
    \end{table}
}%}}}

\begin{document}
\title{進行方向の計算回数削減による
\\ソーシャルフォースモデルを用いた人流シミュレーションの高速化}
\学生番号{2281011}
\author{片寄\ 颯人}
\maketitle

%はじめに短いver{{{
\if 0
\section{はじめに}
駅や商業施設などのように人が多く集まる場所では，
混雑や滞留の対策にソーシャルフォースモデル(SFM)を用いた
人流シミュレーションが広く用いられている\cite{helbing_sfm}．
SFMは，人を運動方程式に基づくエージェントとして再現するモデルである．
SFMを用いた人流シミュレーションは，解析規模に応じて，
エージェントの進行方向を決定する計算に時間がかかるため，
高速化が求められている．
そこで，本稿では，SFMを用いた人流シミュレーションを高速化するために，
進行方向計算中の演算回数を削減する手法を提案する．
\fi
%}}}

\section{はじめに}
商業施設などの人が多く集まる場所の混雑や滞留の対策には，
混雑や滞留の対策にソーシャルフォースモデル(SFM)を用いた
人流シミュレーションが広く用いられている\cite{helbing_sfm}．
SFMは，人を運動方程式に基づくエージェントとして再現するモデルである．
%SFMの運動方程式は，目的地に向かう力，周囲のエージェントや障害物を避ける力の
%合力を用いてエージェントの移動を決定する．
SFMを用いた人流シミュレーションは，解析規模に応じて，
エージェントの進行方向を決定する計算に時間がかかるため，
高速化が求められている．
進行方向を決定する計算は，エージェントの座標に応じて決定する特徴がある．
そこで，本研究では，SFMを用いた人流シミュレーションを高速化するために，
解析領域を格子状に分割した領域ごとに計算可能を進行方向計算中の演算を行うことで，
解析中の進行方向計算時に必要な演算回数を削減する手法を提案する．
%進行方向を決定する計算中の
%目的地に向かう力と障害物を避ける力は，目的地と障害物の座標が変わらないため，
%エージェントの座標に応じて決定する特徴がある．
%そこで，本研究では，SFMを用いた人流シミュレーションを高速化するために，
%解析領域を格子状に分割した領域ごとに目的地に向かう力と障害物を避ける力を
%あらかじめ計算することで，解析中の進行方向計算中の演算回数を削減
%する手法を提案する．

\section{ソーシャルフォースモデル(SFM)}
SFMは，時間ステップごとに各エージェントの進行方向を決定する運動方程式を
解くことで，人々の流れを再現する．
式\eqref{eq:sfm_siki1}にSFMの運動方程式を示す．
%
\begin{align} \label{eq:sfm_siki1}
  m_i \frac{dv_i}{dt} = m_i \frac{v_i^0 e_i - v_i}{\tau_i}
  +\sum_{j(\neq i)}f_{ij}+\sum_{W}f_{iW}
\end{align}
%
式\eqref{eq:sfm_siki1}中の$m_i$はエージェント$i$の体重，
$v_i^0$はエージェント$i$の希望速度，
$e_i$はエージェント$i$の目的地に向かう力，
$v_i$はエージェント$i$の速度，
$\tau_i$は時定数，
$f_{ij}$はエージェントを避ける力，
$f_{iW}$は障害物を避ける力である．
エージェント$i$は，目的地に向かう力とエージェントを避ける力$f_{ij}$，
障害物を避ける力$f_{iw}$の合力を式\eqref{eq:sfm_siki1}を用いて算出する．
SFMの計算例を図\ref{fig:sfm_ex}に示す．
図中の四角は解析領域を分割したセル，
丸はエージェント，緑色の点線はエージェント4の影響範囲，
色の付いた四角は影響範囲の内外判定に用いるセル(近似領域)である．
図\ref{fig:sfm_ex}のように，エージェント4は，緑色の影響範囲内に存在する
エージェント2，7，8から力を受ける．影響範囲内のエージェントを
絞り込むときは，青色の近似領域内のエージェントとエージェント4の距離と角度を
計算する．

\figtb{SFMの計算例}{}{8}{20231226_sfm_ex.eps}{sfm_ex}

\section{進行方向計算中の演算回数削減手法}
SFMを用いた人流シミュレーションは，実問題に対して解析する場合，
エージェントや障害物が多く存在するため，進行方向の計算に時間がかかる．
目的地に向かう力と障害物を避ける力は，目的地と障害物の座標が
解析中に変わらないため，エージェントの座標に応じて決定する特徴がある．
また，エージェントを避ける力は，エージェント間距離に応じて決定する．
そこで，本研究では，解析領域を格子状に分割した領域ごとに，
目的地と障害物を避ける力をあらかじめ計算することで，
解析中の目的地に向かう力と障害物を避ける力の計算回数を削減する．
エージェントを避ける力は，エージェントの座標が解析中に変化することから，
あらかじめ計算できない．このため，提案手法は，
近似領域を影響範囲に高い精度で近似することで，
エージェントを避ける力の計算時のエージェント間距離の計算回数を削減する．
目的地に向かう力と障害物を避ける力を格子分割した例を図\ref{fig:ex}に示す．
図中の丸はエージェント，矢印は目的地に向かう力を表す．
障害物や経由地を含む領域は，エージェントが目的地に正しく進むようにするために
0ベクトルを格納し，エージェントごとに進行方向を再計算する領域に設定する．
エージェント間距離の計算回数を削減するための近似領域の設定方法は，
図\ref{fig:sentaku}に示すように，エージェントの進行方向を判定し，その進行方向に
合わせた青色のセルを近似領域とする．
進行方向の判定は，エージェントの進行方向や視野角などを用いた複数の方法が考えられるため，
本研究では6パターンの判定方法を設定する．
パターンごとの進行方向の分類条件を表\ref{tb:joken}，
判定に用いる変数と近似領域の例を図\ref{fig:kinji}に示す．
パターン1は，既存手法と同様に近似領域を設定する方法である．
パターン2から6は，表\ref{tb:joken}の条件式を用いて近似領域を選択する．
全パターンのなかでも，
パターン3は，パターン2で設定した近似領域から影響範囲が出る場合があるため，
視野座標$(R_x,R_y)$と$(L_x,L_y)$が近似領域から出ていないかを追加で判定し，
影響範囲が近似領域から出ている場合，パターン1と同じ近似領域を用いる．


%\figtb{提案する格子分割の例}{}{5.5}{ex1.eps}{grid_ex1}
\figtb{進行方向の格子分割の例}{}{8}{5_e_vec_ex1.eps}{ex}

\figtb{進行方向ごとの近似領域}{}{5.5}{20220225_sentaku.eps}{sentaku}

\判定条件new

\figtb{エージェント4の実装パターンごとの近似領域の例}{}{8}{20231007_hanni.eps}{kinji}

\section{評価}
提案手法の人流シミュレーションに対する有効性を確認するために，
セル分割法と提案手法のエージェント間計算回数と実行時間を測定する．
評価環境は，CPUがIntel Xeon E5-2667W v2，メモリが64GBのマシンと
CPUがIntel Xeon E5-2687W v2，メモリが64GBのマシンである．
評価に用いる配置は，\figref{fig:agent_haichi}に示すような直進と交差の配置であり．
解析領域が$50m\times50m$である．
直進の配置は，建物内のように障害物に囲まれた通路を進む状況を再現する配置である．
また，交差の配置は，SFMで期待される押し合い圧し合いを行う群集の行動を再現する配置である．
測定に用いるエージェントのパラメータは，関連研究\cite{helbing_sfm}と同様のパラメータを用いる．
図\ref{fig:haba_sakugenritu}に直進の配置における通路幅を変えたときの格子ごとの進行方向計算の削減率，
図\ref{fig:haba_kousokuka}に直進の配置における提案手法の既存手法に対する高速化率を示す．
また，表\ref{fig:result}に交差の配置におけるエージェント間距離の計算回数，
図\ref{fig:kousokuka2}に交差の配置における提案手法の既存手法に対する高速化率を示す．
%
高速化率，削減率は式(\ref{eq:kousokukaritu})，
式(\ref{eq:sakugenritu})を用いる．
式(\ref{eq:kousokukaritu})中の$T_{k}$は既存手法の
計算回数，$T_{t}$は，提案手法のの計算回数である．
%
\begin{eqnarray}
  \label{eq:kousokukaritu}
  \mbox{高速化率[倍]} =
  \frac{\mbox{セル分割法の実行時間[s]}}{\mbox{提案手法の実行時間[s]}}
\end{eqnarray}
%
\begin{eqnarray}
  \label{eq:sakugenritu}
  \mbox{削減率[\%]} =
  \frac{T_{k} - T_{t}}{T_{k}} \times 100
\end{eqnarray}\vspace{1mm}
%
図\ref{fig:haba_sakugenritu}，図\ref{fig:haba_kousokuka}より，
提案手法は，既存手法よりも計算回数を削減し，高速化できることが確認できる．
格子サイズが0.19mや0.09mのような提案手法では，解析前にあらかじめ計算する
進行方向の計算回数が多くなるため，進行方向計算中の演算回数が削減できない
ことがわかる．
格子分割による進行方向計算回数削減は，解析領域を格子状に分割した領域ごとの
進行方向を用いるため，既存手法との誤差が生じる．
誤差は，タイムステップごとの各エージェントの提案手法と既存手法の座標の
差であり，本評価では最大2.6cmである．
本手法で生じる誤差は，解析領域が$50m\times50m$であることを踏まえると
非常に小さな値であるため，影響が小さいと考えられる．
表\ref{tb:keisan_kaisu}より，提案手法は，パターン2の近似領域で最大24\%削減できる
ことが確認できる．また，提案手法の既存手法に対する高速化率は，
パターン2が最も高く，最大で1.25倍である．
パターン2は，影響範囲から近似領域が出る場合があるため，誤差が生じる．
本測定で生じた誤差は，交差の配置で最大3.5cmである．
誤差を許容できない場合は，パターン3を用いることで，
既存手法と同じ精度で最大1.24倍の高速化率を得ることができる．

\figtb{エージェントの初期配置}{Initial position of agents.}{8}{agent_position.eps}{agent_haichi}

%格子分割の手法結果
\figtb{格子サイズごとの計算回数の削減率}{}{8.0}{haba_sakugenritu2.eps}{haba_sakugenritu}
\figtb{格子サイズごとのシミュレーション時間の高速化率}{}{8.0}{haba_kousokuka.eps}{haba_kousokuka}

%エージェント間距離の削減結果
\距離計算new
\figtb{パターン1（セル分割法）に対する高速化率}{}{8}{20230226_kousokuka.eps}{kousokuka2}

\section{おわりに}
本研究では，SFMを用いた人流シミュレーションを高速化するために，
進行方向計算中の演算回数を削減する手法を提案し，その有効性を評価した．
評価の結果，提案手法は，
進行方向計算中の目的地に向かう力と障害物を避ける力の計算回数の削減効果で最大1.93倍，
エージェント間距離の計算回数削減効果で最大1.25倍高速に解析できることを確認した．
また，提案手法で発生した誤差よりも大きい誤差を許容することが出来る場合，
近似領域の影響範囲に対する近似精度を高めることが可能であり，
エージェント間距離の計算回数の削減率を高め，さらなる高速化が見込める．
%あああああああああああああああああああああああああああああああああ
%あああああああああああああああああああああああああああああああああ
%あああああああああああああああああああああああああああああああああ
%あああああああああああああああああああああああああああああああああ


\begin{thebibliography}{9}
\footnotesize
\bibitem{helbing_sfm}
  Helbing, D. and Molnar, P.: Social force model for pedestrian dynamics，{\em
    Physical review E}， Vol.~51, No.~5, p.\ 4282 (1995).

\bibitem{21_Isozaki}
  磯崎勝吾，中辻隆：Social force
  modelを基にした歩行者の避難シミュレーションモデルに関する研究，土木学会北海道支部論文報告集，
  Vol.~66 (2009).
\end{thebibliography}

\end{document}
