\documentclass{maelab_y}
%\documentstyle{jarticle}
\usepackage{graphicx}
\usepackage[dvipdfmx]{color}
\usepackage{multirow}
\usepackage{here}
\usepackage{amsmath}

\newcommand{\figtb}[5]{ %引数 {日本語タイトル}{英語タイトル}{サイズ}{ファイル名}{ラベル名}{{{
%\vspace{-0.5em}
\begin{figure}[hbtp]
  \begin{center}
    \includegraphics[width=#3cm,clip]{figure/#4}
    \caption{#1}
    \label{fig:#5}
  \end{center}
\end{figure}
%\vspace{-1em}
}%}}}

\newcommand{\分類条件}{%{{{
\begin{table}[t]
\begin{center}
\caption{進行方向を分類する条件}
\ecaption{Classification condition of moving direction $e_{i}$.}
\label{tb:hantei_jouken}
\begin{tabular}{c|c|c|c|c}
\hline \hline
			& 右 & 左 & 上 & 下 \\ \hline
パターン2   & $\frac{1}{\sqrt{2}} < e_x \leq 1  $
		    & $ -1 \leq e_x < \frac{-1}{\sqrt{2}}$ 
		    & $ \frac{-1}{\sqrt{2}} < e_x < \frac{1}{\sqrt{2}} $ 
		    & $ \frac{-1}{2} < e_x < \frac{1}{2} $ \\
パターン3   & $\frac{-1}{2} < e_y < \frac{1}{2} $ 
		    & $\frac{-1}{2} < e_y < \frac{1}{2} $
            & $ \frac{1}{\sqrt{2}} < e_y \leq 1$
		    & $ -1 \leq e_y < \frac{-1}{\sqrt{2}} $ \\
\hline
\multirow{2}{*}{パターン4}   
			& $R_x \geq A_x$ & $R_x < A_x$ & $R_y \geq A_y$ & $R_y < A_y $ \\
	        &  $L_x \geq A_x$ & $L_x < A_x$ & $L_y \geq A_y$ & $L_y < A_y$ \\
\hline
\multirow{2}{*}{パターン5}   
 			& $R_x \geq x_1$ & $R_x < x_2$ & $R_y \geq y_1$ & $R_y < y_2 $ \\
			& $L_x \geq x_1$ & $L_x < x_2$ & $L_y \geq y_1$ & $L_y < y_2 $ \\
\hline
パターン6   & $ \cos(\frac{1}{2}\theta_{view}) \leq  e_y $ 
			& $ e_y \leq -\cos(\frac{1}{2}\theta_{view})$ 
			& $ \sin(\frac{1}{2}(\pi - \theta_{view})) \leq e_x $ 
			& $ e_x \leq \sin(\frac{1}{2}(\pi - \theta_{view}))  $ \\
\hline
\end{tabular}
\end{center}
\end{table}}%}}}

\newcommand{\距離計算new}{%{{{
  \begin{table}[hbtp]
    \begin{center}
    \caption{エージェント間距離の計算回数[$10^{10}$回]}
    \label{tab:my-table}
    \begin{tabular}{c|llllll}
    \hline \hline
    \multirow{2}{*}{人数}   & \multicolumn{6}{c}{パターン}                                                                                                                                                             \\ \cline{2-7} 
                          & \multicolumn{1}{c|}{1}    & \multicolumn{1}{c|}{2}               & \multicolumn{1}{c|}{3}      & \multicolumn{1}{c|}{4}      & \multicolumn{1}{c|}{5}      & \multicolumn{1}{c}{6}    \\ \hline
    \multirow{2}{*}{3000} & \multicolumn{1}{r|}{5.1}  & \multicolumn{1}{r|}{\textbf{3.9}}    & \multicolumn{1}{r|}{4.0}    & \multicolumn{1}{r|}{4.4}    & \multicolumn{1}{r|}{4.1}    & \multicolumn{1}{r}{4.4}  \\
                          & \multicolumn{1}{l|}{}     & \multicolumn{1}{l|}{\textbf{(24\%)}} & \multicolumn{1}{l|}{(23\%)} & \multicolumn{1}{l|}{(15\%)} & \multicolumn{1}{l|}{(21\%)} & (15\%)                   \\ \hline
    \multirow{2}{*}{5000} & \multicolumn{1}{r|}{14.4} & \multicolumn{1}{r|}{\textbf{10.9}}   & \multicolumn{1}{r|}{11.1}   & \multicolumn{1}{r|}{12.2}   & \multicolumn{1}{r|}{11.4}   & \multicolumn{1}{r}{12.2} \\
                          & \multicolumn{1}{l|}{}     & \multicolumn{1}{l|}{\textbf{(24\%)}} & \multicolumn{1}{l|}{(23\%)} & \multicolumn{1}{l|}{(15\%)} & \multicolumn{1}{l|}{(21\%)} & (15\%)                   \\ \hline
    \multirow{2}{*}{7500} & \multicolumn{1}{r|}{33.1} & \multicolumn{1}{r|}{\textbf{25.2}}   & \multicolumn{1}{r|}{25.8}   & \multicolumn{1}{r|}{28.3}   & \multicolumn{1}{r|}{26.7}   & \multicolumn{1}{r}{28.3} \\
                          & \multicolumn{1}{l|}{}     & \multicolumn{1}{l|}{\textbf{(24\%)}} & \multicolumn{1}{l|}{(22\%)} & \multicolumn{1}{l|}{(15\%)} & \multicolumn{1}{l|}{(20\%)} & (15\%)                   \\ \hline
    \end{tabular}
    \end{center}
    \end{table}
}%}}}

\newcommand{\粒子数}{%{{{
\begin{table}[hbtp]
  \begin{center}
    \caption{各配置の詳細}
    \label{tb:haichi_para}
    \begin{tabular}{c|c|c}
      \hline \hline
      & 教室 & 演習室 \\ \hline 
      エージェント数[人] & 96 & 204 \\ \hline
      壁粒子数[個] & 1037 & 1454\\ \hline
      経由地数[個] & 12   & 26 \\ \hline
      解析領域 & $50m\times50m$ & $50m\times50m$ \\ \hline
    \end{tabular}
  \end{center}
\end{table}
}%}}}

\newcommand{\評価環境}{%{{{
\begin{table}[hbtp]
  \begin{center}
    \caption{各配置の詳細}
    \label{tb:haichi_para}
    \begin{tabular}{c|c|c}
      \hline \hline
                 & マシン1                & マシン2 \\ \hline 
      CPU        & Intel Xeon E5-2687W & Intel Xeon E5-2667W \\ \hline
      メモリ     & 64GB                   & 64GB \\ \hline
      OS         & Linux 4.12.9            & Linux 6.5.8 \\ \hline
      コンパイラ & gcc 7.2.0             & gcc 13.2.0 \\ \hline
    \end{tabular}
  \end{center}
\end{table}
}%}}}


\begin{document}
\title{進行方向の計算回数削減による
\\ソーシャルフォースモデルを用いた人流シミュレーションの高速化}
\学生番号{2281011}
\author{片寄\ 颯人}
\maketitle

\if 0%はじめに短いver{{{
\section{はじめに}
駅や商業施設などのように人が多く集まる場所では，利便性や災害時の
安全性の観点から，混雑や滞留の対策が重要であり，
混雑や滞留の対策にソーシャルフォースモデル(SFM)を用いた
人流シミュレーションが広く用いられている\cite{helbing_sfm}．
SFMは，人を運動方程式に基づくエージェントとして再現するモデルである．
SFMを用いた人流シミュレーションは，解析規模に応じて，
エージェントの進行方向を決定する計算に時間がかかるため，
高速化が求められている．
そこで，本稿では，SFMを用いた人流シミュレーションを高速化するために，
進行方向計算中の演算回数を削減する手法を提案する．
\fi%}}}

\section{はじめに}
駅や商業施設などのように人が多く集まる場所では，利便性や災害時の
安全性の観点から，混雑や滞留の対策が重要であり，
混雑や滞留の対策にソーシャルフォースモデル(SFM)を用いた
人流シミュレーションが広く用いられている\cite{helbing_sfm}．
SFMは，人を運動方程式に基づくエージェントとして再現するモデルである．
SFMの運動方程式は，目的地に向かう力，周囲のエージェントや障害物を避ける力の
合力を用いてエージェントの移動を決定する．
SFMを用いた人流シミュレーションは，解析規模に応じて，
エージェントの進行方向を決定する計算に時間がかかるため，
高速化が求められている．
進行方向を決定する計算中の
目的地に向かう力と障害物を避ける力は，目的地と障害物の座標が変わらないため，
エージェントの座標に応じて決定する特徴がある．
そこで，本研究では，SFMを用いた人流シミュレーションを高速化するために，
解析領域を格子状に分割した領域ごとに目的地に向かう力と障害物を避ける力を
あらかじめ計算することで，解析中の進行方向計算中の演算回数を削減
する手法を提案する．

\section{ソーシャルフォースモデル(SFM)}
SFMは，時間ステップごとに各エージェントの進行方向を決定する運動方程式を
解くことで，人々の流れを再現する．
式\eqref{eq:sfm_siki1}にSFMの運動方程式を示す．
%
\begin{align} \label{eq:sfm_siki1}
  m_i \frac{dv_i}{dt} = m_i \frac{v_i^0 e_i - v_i}{\tau_i}
  +\sum_{j(\neq i)}f_{ij}+\sum_{W}f_{iW}
\end{align}
%
式\eqref{eq:sfm_siki1}中の$m_i$はエージェント$i$の体重，
$v_i^0$はエージェント$i$の希望速度，
$e_i$はエージェント$i$の目的地に向かう力，
$v_i$はエージェント$i$の速度，
$\tau_i$は時定数，
$f_{ij}$はエージェントを避ける力，
$f_{iW}$は障害物を避ける力である．
エージェント$i$は，目的地に向かう力とエージェントを避ける力$f_{ij}$，
障害物を避ける力$f_{iw}$の合力を式\eqref{eq:sfm_siki1}を用いて算出する．
SFMの計算例を\figref{fig:sfm_ex}に示す．
図中の四角は解析領域を分割したセル，赤丸は計算対象のエージェント，
黒丸は他のエージェント，緑色の点線は影響範囲，
色の付いた四角は影響範囲の内外判定に用いるセル(近似領域)である．
\figref{fig:sfm_ex}の例は，エージェント△の計算例であり，
エージェント△

図\ref{fig:sfm_ex}の例では，エージェント0の進行方向を計算するとき，
色のついたセルに存在するエージェントに対して距離を計算し，
影響範囲内であるか判定する．
このとき，判定に用いるセルは，色の付いたセルであるため，白いセルに存在する
エージェントの影響範囲内であるかの判定を減らすことができる．

\figtb{SFMの計算例(影響範囲の色と範囲を変更)}{}{8}{20231226_sfm_ex.eps}{sfm_ex}

\section{進行方向計算中の演算回数削減手法}
SFMを用いた人流シミュレーションは，実問題に対して解析する場合，
エージェントや障害物が多く存在するため，進行方向の計算に時間がかかる．
目的地に向かう力と障害物を避ける力は，目的地と障害物の座標が
解析中に変わらないため，エージェントの座標に応じて決定する特徴がある．
また，エージェントを避ける力は，エージェント間距離に応じて決定する．
そこで，本研究では，解析領域を格子状に分割した領域ごとに，
目的地と障害物を避ける力をあらかじめ計算することで，
解析中の目的地に向かう力と障害物を避ける力の計算回数を削減する．
エージェントを避ける力は，エージェントの座標が解析中に変化することから，
あらかじめ計算できない．このため，提案手法は，
近似領域を影響範囲に高い精度で近似することで，
エージェントを避ける力の計算時のエージェント間距離の計算回数を削減する．
格子分割した領域ごとに目的地に向かう力と障害物を避ける力の例を
図\ref{fig:grid_ex1}に示す．


\figtb{提案する格子分割の例}{}{5.5}{ex1.eps}{grid_ex1}
\figtb{経由地がある場合の進行方向の例}{}{7}{5_e_vec_ex1.eps}{ex2}


\figtb{進行方向ごとの近似領域}{}{5.5}{20220225_sentaku.eps}{sentaku}
\figtb{エージェント4の実装パターンごとの近似領域の例}{}{7}{20231007_hanni.eps}{90do_hamideru}

\section{評価}
提案手法の人流シミュレーションに対する有効性を確認するために，
セル分割法と提案手法のエージェント間計算回数と実行時間を測定する．
評価環境は，CPUがIntel Xeon E5-2667W v2，メモリが64GBのマシンと
CPUがIntel Xeon E5-2687W v2，メモリが64GBのマシンを用いる．
評価に用いる配置は，\figref{fig:agent_haichi}に示すような直進と交差の配置である．
直進の配置は，建物内のように障害物に囲まれた通路を進む状況を再現する配置である．
また，交差の配置は，SFMで期待される押し合い圧し合いを行う群集の行動を再現する配置である．




測定に用いる初期配置は，図\ref{fig:agent_haichi_image}に示すように，
交差と直進の配置である．
表\ref{tab:result}にセル分割法と提案手法の実行時間と高速化率，削減率を示す．
高速化率，削減率は式(\ref{eq:kousokukaritu})，
式(\ref{eq:sakugenritu})を用いる．
式(\ref{eq:kousokukaritu})中の$T_{k}$は既存手法の
エージェント間距離の計算回数，$T_{t}$は，提案手法の
エージェント間距離の計算回数である．
%
\begin{eqnarray}
  \label{eq:kousokukaritu}
  \mbox{高速化率[倍]} =
  \frac{\mbox{セル分割法の実行時間[s]}}{\mbox{提案手法の実行時間[s]}}
\end{eqnarray}
%
\begin{eqnarray}
  \label{eq:sakugenritu}
  \mbox{削減率[\%]} =
  \frac{T_{k} - T_{t}}{T_{k}} \times 100
\end{eqnarray}\vspace{1mm}
%
表\ref{tab:result}より，提案手法は，既存手法よりも高速に解析
できることが確認できた．また，
提案手法のエージェント間距離の計算回数の
削減率は，交差の配置で約21\%，直進の配置で約31\%であり，
提案手法の高速化率は，既存手法に対して約1.5倍であることが
確認できた．これは，提案手法によるエージェント
間距離の計算回数が削減により，解析時間の短縮に繋がったから
と考えられる．また，直進の配置の方が削減率が高いのは，
後ろに近傍のエージェントが存在することが多いことが要因であると考えられる．


\figtb{エージェントの初期配置}{Initial position of agents.}{7}{agent_position.eps}{agent_haichi}


\距離計算new
\figtb{パターン1（セル分割法）に対する高速化率}{}{8}{20230226_kousokuka.eps}{kousokuka2}

\section{おわりに}
本稿では，視野を用いた人流シミュレーションを高速化するために，
SFMのエージェント間距離の
計算回数を削減する手法を提案し，その有効性を評価した．評価の結果，提案手法の実行時間は，セル分割法に対して約1.5倍高速化することが確認できた．

\begin{thebibliography}{9}
\footnotesize
\bibitem{helbing_sfm}
  Helbing, D. and Molnar, P.: Social force model for pedestrian dynamics，{\em
    Physical review E}， Vol.~51, No.~5, p.\ 4282 (1995).

\bibitem{21_Isozaki}
  磯崎勝吾，中辻隆：Social force
  modelを基にした歩行者の避難シミュレーションモデルに関する研究，土木学会北海道支部論文報告集，
  Vol.~66 (2009).
\end{thebibliography}

\end{document}
